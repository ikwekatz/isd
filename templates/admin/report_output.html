{% load humanize %}

<div class="table-responsive">
    <table class="table table-bordered table-striped table-hover align-middle">
        <thead class="table-dark">
        <tr>
            <th width="5%">SN</th>
            <th width="20%">Activity</th>
            <th width="30%">Implementation</th>
            <th width="15%" class="text-end">Budget</th>
            <th width="15%" class="text-end">Expenditure</th>
            <th width="15%" class="text-end">Balance</th>
        </tr>
        </thead>
        <tbody>
        {% for item in report_data %}
        <tr>
            <td class="text-center">{{ forloop.counter }}</td>
            <td>
                <strong>{{ item.activity.name }}</strong>
                {% if item.activity.description %}
                <div class="text-muted small mt-1">{{ item.activity.description }}</div>
                {% endif %}
            </td>
            <td>
                {% for impl in item.implementations %}
                <div class="implementation mb-3">
                    <h6 class="text-primary fw-bold mb-1">{{ impl.service }}</h6>
                    <div class="implementation-details ps-3">{{ impl.description|safe }}</div>
                </div>
                {% if not forloop.last %}<hr class="my-2">{% endif %}
                {% endfor %}
            </td>

            <!-- Budget column -->
            <td class="text-end">
                {% for b in item.budgets %}
                {{ b.budget_type }}: {{ b.total_budget|floatformat:2|intcomma }}<br>
                {% endfor %}
                <strong>Total: {{ item.total_budget|floatformat:2|intcomma }}</strong>
            </td>

            <!-- Expenditure column -->
            <td class="text-end">
                {% for b in item.budgets %}
                {% with item.exp_map.budget_type as exp %}
                {{ exp|default:"0.00"|floatformat:2|intcomma }}<br>
                {% endwith %}
                {% endfor %}
                <strong>Total: {{ item.total_expenditure|floatformat:2|intcomma }}</strong>
            </td>

            <!-- Balance column -->
            <td class="text-end">
                {% for b in item.budgets %}
                {% with item.balance_map.budget_type as bal %}
                {{ bal|default:"0.00"|floatformat:2|intcomma }}<br>
                {% endwith %}
                {% endfor %}
                <strong>Total: {{ item.balance_total|floatformat:2|intcomma }}</strong>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="text-center text-muted py-4">No data found for the selected criteria</td>
        </tr>
        {% endfor %}
        </tbody>

        <tfoot class="table-light fw-bold">
        <tr>
            <td colspan="3" class="text-end">Total</td>
            <td class="text-end">{{ total_budget|floatformat:2|intcomma|default:"-" }}</td>
            <td class="text-end">{{ total_expenditure|floatformat:2|intcomma|default:"-" }}</td>
            <td class="text-end">{{ total_balance|floatformat:2|intcomma|default:"-" }}</td>
        </tr>
        </tfoot>
    </table>
</div>
